기존의 코딧은 결제 플랜으로 오직 LITE플랜만 가지고 있었습니다.
이 LITE 플랜은 특정 기능을 제한하고, 14일의 무료체험, 그리고 매달 정기 결제되는 기능을 가지고 있습니다.
그러나 단일 플랜만을 위한 기능이다 보니, 확장성을 고려하지 않고 만들어졌습니다.

이번 버전에서 NEWS 플랜을 추가하며 부가서비스 기능이 추가되고, 연간 월간 결제 등을 추가하기로 하면서 결제 기능의 거의 전 과정을 손봐야 했습니다.

# 기존 방식의 문제점
## 데이터베이스 설계

기존에는 플랜 정보를 저장하는 테이블이 존재하지 않았습니다.
product 테이블이 존재하고, payType 필드를 사용해서 플랜을 구분했습니다. PUBLIC은 사용하지 않고 있기 때문에 사실상 LITE 플랜만 존재하는 상태입니다.
![[Pasted image 20250723102932.png]]
이 방식의 문제점은 아래와 같습니다.

- 각 플랜에 일관적인 기준을 적용하기 어렵습니다. 예를 들어, LITE 플랜의 가격이 49900원일 때, 이를 수정하려면 모든 행의 price값을 수정해야 합니다.
- LITE 플랜의 아이템이 모두 사라지면, 플랜에 대한 정보가 사라집니다.

이번 기획에서는 플랜별 정보를 제공하고, 각 플랜들끼리 일관성 있게 관리를 해야하기 때문에 플랜 정보를 저장하는 테이블을 설계하고, 각 플랜에 속하는 상품을 product에 저장하는 방식을 설계하기로 했습니다.

## 결제 로직의 문제
현재 코드는 백엔드 api 서버와 스케줄러가 구분되어 있습니다.

기존 결제 방식은 누군가 플랜을 결제하면, DB에 카드, 결제 정보가 등록되고 isRecurring 값이 1로 변경됩니다. 이 값이 1이면 스케줄러가 3분 간격으로 해당 계정들을 결제시키게 돼있었습니다.

이 방식에는 몇가지 문제가 있습니다.
- 스케줄러가 멈추면 결제가 이뤄지지 않습니다.
- 즉시 결제가 이뤄지지 않습니다. 즉시 결제가 이뤄지지 않으면 사용자 경험에 좋지 않고, 결제가 되지 않은 잠깐의 시간 사이에 생길 수 있는 사이드 이펙트에 대응 해야 합니다.

이번 업데이트에서는 연간 결제와 월간 결제가 구분되고 플랜간 변경, 결제 취소 등 다양한 케이스가 추가되면서 즉시 결제가 가능하도록 로직을 수정하며 다양한 케이스에 대응할 수 있도록 모듈화를 잘 해둬야 합니다.

